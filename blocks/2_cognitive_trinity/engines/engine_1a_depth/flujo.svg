<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1450" viewBox="0 0 1000 1450">
<defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.12"/>
    </filter>
    
    <style>
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #263238; }
        .title { font-size: 22px; font-weight: 800; fill: #fff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-size: 13px; font-weight: 700; fill: #000; }
        .detail { font-size: 11px; fill: #455a64; }
        .code { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #e65100; }
        
        .box-step { fill: #ffffff; stroke: #455a64; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-process { fill: #fff3e0; stroke: #ef6c00; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-refine { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-calib { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-cloud { fill: #e3f2fd; stroke: #1565c0; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        .arrow { stroke: #546e7a; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-orange { stroke: #ef6c00; stroke-width: 2; fill: none; marker-end: url(#arrowhead-orange); }
        .arrow-purple { stroke: #7b1fa2; stroke-width: 2; fill: none; marker-end: url(#arrowhead-purple); }
        .arrow-green { stroke: #2e7d32; stroke-width: 2; stroke-dasharray: 5,3; fill: none; marker-end: url(#arrowhead-green); }
        
        .badge { fill: #263238; rx: 4; }
        .badge-new { fill: #7b1fa2; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
    
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#546e7a"/>
    </marker>
    <marker id="arrowhead-orange" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#ef6c00"/>
    </marker>
    <marker id="arrowhead-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#2e7d32"/>
    </marker>
    <marker id="arrowhead-purple" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#7b1fa2"/>
    </marker>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="1000" height="70" fill="#ef6c00"/>
<text x="500" y="35" text-anchor="middle" class="title">ENGINE 1A: DEPTH FLOW</text>
<text x="500" y="55" text-anchor="middle" class="subtitle">Monocular Depth • Refinement Pipeline • Point Cloud • 25ms</text>

<!-- STEP 1: INPUT -->
<g transform="translate(350, 100)">
    <rect x="0" y="0" width="300" height="60" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">1. RECEIVE FRAME</text>
    <text x="150" y="45" text-anchor="middle" class="code">frame [H×W×3] + prev_depth</text>
</g>
<line x1="500" y1="160" x2="500" y2="190" class="arrow-orange"/>

<!-- STEP 2: RESIZE -->
<g transform="translate(350, 190)">
    <rect x="0" y="0" width="300" height="70" class="box-process"/>
    <text x="150" y="22" text-anchor="middle" class="label" fill="#ef6c00">2. RESIZE INPUT</text>
    <text x="150" y="42" text-anchor="middle" class="code">resized = resize(frame, (518, 518))</text>
    <rect x="110" y="52" width="80" height="12" class="badge"/>
    <text x="150" y="61" text-anchor="middle" class="badge-text">2 ms</text>
</g>
<line x1="500" y1="260" x2="500" y2="290" class="arrow-orange"/>

<!-- STEP 3: DEPTH INFERENCE -->
<g transform="translate(300, 290)">
    <rect x="0" y="0" width="400" height="100" class="box-process"/>
    <text x="200" y="22" text-anchor="middle" class="label" fill="#ef6c00">3. DepthAnything-v2 INFERENCE</text>
    
    <g transform="translate(20, 35)">
        <rect x="0" y="0" width="360" height="40" rx="4" fill="#ffe0b2" stroke="#ef6c00"/>
        <text x="180" y="18" text-anchor="middle" class="code">relative_depth = depth_model(resized)</text>
        <text x="180" y="32" text-anchor="middle" class="detail">ViT-L/14 + TensorRT FP16</text>
    </g>
    
    <rect x="160" y="78" width="80" height="14" class="badge"/>
    <text x="200" y="89" text-anchor="middle" class="badge-text">18 ms</text>
</g>
<line x1="500" y1="390" x2="500" y2="420" class="arrow-orange"/>

<!-- CALIBRATION INPUT -->
<g transform="translate(720, 340)">
    <rect x="0" y="0" width="200" height="70" class="box-calib"/>
    <text x="100" y="22" text-anchor="middle" class="label" fill="#2e7d32">LAYER 1</text>
    <text x="100" y="42" text-anchor="middle" class="code">scale_factor</text>
    <text x="100" y="57" text-anchor="middle" class="detail">Rail geometry</text>
</g>
<path d="M 820 410 L 820 455 L 700 455" class="arrow-green"/>

<!-- STEP 4: METRIC SCALE -->
<g transform="translate(300, 420)">
    <rect x="0" y="0" width="400" height="70" class="box-calib"/>
    <text x="200" y="22" text-anchor="middle" class="label" fill="#2e7d32">4. APPLY METRIC SCALE</text>
    <text x="200" y="45" text-anchor="middle" class="code">depth_m = relative × scale_factor</text>
    <rect x="160" y="52" width="80" height="14" class="badge"/>
    <text x="200" y="63" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>
<line x1="500" y1="490" x2="500" y2="520" class="arrow-purple"/>

<!-- REFINEMENT BLOCK (NEW) -->
<g transform="translate(250, 520)">
    <rect x="0" y="0" width="500" height="220" class="box-refine"/>
    <text x="250" y="22" text-anchor="middle" class="label" fill="#7b1fa2">REFINEMENT PIPELINE</text>
    
    <!-- Step 5: Outlier Detection -->
    <g transform="translate(20, 40)">
        <rect x="0" y="0" width="145" height="75" rx="4" fill="#fff" stroke="#7b1fa2"/>
        <text x="72" y="18" text-anchor="middle" class="label" style="font-size:10px" fill="#7b1fa2">5. Outlier Detect</text>
        <text x="72" y="36" text-anchor="middle" class="code">median_filter(3×3)</text>
        <text x="72" y="50" text-anchor="middle" class="detail">threshold: 20%</text>
        <rect x="32" y="58" width="80" height="12" class="badge"/>
        <text x="72" y="67" text-anchor="middle" class="badge-text">&lt;1 ms</text>
    </g>
    
    <!-- Arrow -->
    <path d="M 165 78 L 178 78" fill="none" stroke="#7b1fa2" stroke-width="2" marker-end="url(#arrowhead-purple)"/>
    
    <!-- Step 6: Guided Filter -->
    <g transform="translate(178, 40)">
        <rect x="0" y="0" width="145" height="75" rx="4" fill="#fff" stroke="#7b1fa2"/>
        <text x="72" y="18" text-anchor="middle" class="label" style="font-size:10px" fill="#7b1fa2">6. Guided Filter</text>
        <text x="72" y="36" text-anchor="middle" class="code">edge_aware(rgb, depth)</text>
        <text x="72" y="50" text-anchor="middle" class="detail">r=2, ε=0.01</text>
        <rect x="32" y="58" width="80" height="12" class="badge"/>
        <text x="72" y="67" text-anchor="middle" class="badge-text">1 ms</text>
    </g>
    
    <!-- Arrow -->
    <path d="M 323 78 L 336 78" fill="none" stroke="#7b1fa2" stroke-width="2" marker-end="url(#arrowhead-purple)"/>
    
    <!-- Step 7: Temporal Smoothing -->
    <g transform="translate(336, 40)">
        <rect x="0" y="0" width="145" height="75" rx="4" fill="#fff" stroke="#7b1fa2"/>
        <text x="72" y="18" text-anchor="middle" class="label" style="font-size:10px" fill="#7b1fa2">7. Temporal EMA</text>
        <text x="72" y="36" text-anchor="middle" class="code">α·current + (1-α)·prev</text>
        <text x="72" y="50" text-anchor="middle" class="detail">α = 0.7</text>
        <rect x="32" y="58" width="80" height="12" class="badge"/>
        <text x="72" y="67" text-anchor="middle" class="badge-text">1 ms</text>
    </g>
    
    <!-- prev_depth input -->
    <g transform="translate(336, 130)">
        <rect x="0" y="0" width="145" height="35" rx="4" fill="#e1bee7" stroke="#7b1fa2" stroke-dasharray="4,2"/>
        <text x="72" y="22" text-anchor="middle" class="detail" fill="#7b1fa2">← from prev frame</text>
    </g>
    
    <text x="240" y="140" text-anchor="middle" class="detail" fill="#7b1fa2">refined_depth = EMA(guided(clean(raw)))</text>
    <rect x="180" y="155" width="120" height="18" class="badge"/>
    <text x="240" y="168" text-anchor="middle" class="badge-text">Total: 3 ms</text>
</g>
<line x1="500" y1="740" x2="500" y2="770" class="arrow-orange"/>

<!-- STEP 8: UPSCALE -->
<g transform="translate(350, 770)">
    <rect x="0" y="0" width="300" height="60" class="box-process"/>
    <text x="150" y="22" text-anchor="middle" class="label" fill="#ef6c00">8. UPSCALE</text>
    <text x="150" y="42" text-anchor="middle" class="code">depth_full = resize(refined, (H, W))</text>
</g>
<line x1="500" y1="830" x2="500" y2="860" class="arrow-orange"/>

<!-- STEP 9: POINT CLOUD -->
<g transform="translate(300, 860)">
    <rect x="0" y="0" width="400" height="80" class="box-cloud"/>
    <text x="200" y="22" text-anchor="middle" class="label" fill="#1565c0">9. GENERATE POINT CLOUD</text>
    <text x="200" y="45" text-anchor="middle" class="code">xyz = inverse_projection(depth_full, K)</text>
    <rect x="160" y="60" width="80" height="14" class="badge"/>
    <text x="200" y="71" text-anchor="middle" class="badge-text">2 ms</text>
</g>
<line x1="500" y1="940" x2="500" y2="970" class="arrow"/>

<!-- STEP 10: ENHANCED CONFIDENCE -->
<g transform="translate(300, 970)">
    <rect x="0" y="0" width="400" height="100" class="box-refine"/>
    <text x="200" y="22" text-anchor="middle" class="label" fill="#7b1fa2">10. ENHANCED CONFIDENCE</text>
    
    <g transform="translate(20, 35)">
        <rect x="0" y="0" width="360" height="45" rx="4" fill="#fff" stroke="#7b1fa2"/>
        <text x="180" y="18" text-anchor="middle" class="code">conf = f(range, texture, edges, temporal)</text>
        <text x="180" y="35" text-anchor="middle" class="detail">Weights: 40% • 20% • 20% • 20%</text>
    </g>
</g>
<line x1="500" y1="1070" x2="500" y2="1100" class="arrow"/>

<!-- OUTPUT -->
<g transform="translate(300, 1100)">
    <rect x="0" y="0" width="400" height="120" class="box-step" style="stroke:#1565c0;stroke-width:3"/>
    <text x="200" y="25" text-anchor="middle" class="label" fill="#1565c0">OUTPUT → ENGINE 1B</text>
    <text x="200" y="50" text-anchor="middle" class="code">return depth_map, point_cloud, confidence</text>
    
    <rect x="30" y="70" width="100" height="25" rx="4" fill="#1565c0"/>
    <text x="80" y="87" text-anchor="middle" class="badge-text">depth_map</text>
    <rect x="150" y="70" width="100" height="25" rx="4" fill="#1565c0"/>
    <text x="200" y="87" text-anchor="middle" class="badge-text">point_cloud</text>
    <rect x="270" y="70" width="100" height="25" rx="4" fill="#7b1fa2"/>
    <text x="320" y="87" text-anchor="middle" class="badge-text">confidence</text>
</g>

<!-- TOTAL TIMING -->
<g transform="translate(750, 1280)">
    <rect x="0" y="0" width="200" height="70" rx="6" fill="#263238"/>
    <text x="100" y="22" text-anchor="middle" class="badge-text" style="font-size:14px">TOTAL: 25 ms</text>
    <text x="100" y="42" text-anchor="middle" class="badge-text" style="font-size:9px">2+18+3+2 ms</text>
    <text x="100" y="58" text-anchor="middle" class="badge-text" style="font-size:8px;fill:#ce93d8">+3ms Refinement</text>
</g>

</svg>
