<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="950" viewBox="0 0 1400 950">
<defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.15"/>
    </filter>

    <style>
        /* FONTS */
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #212121; }
        .title { font-weight: 800; font-size: 22px; fill: #ffffff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-weight: 700; font-size: 14px; fill: #000; }
        .detail { font-size: 11px; fill: #455a64; }
        .model { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; font-weight: 600; fill: #004d40; }
        .param { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #00695c; }
        
        /* BOXES */
        .box-main { fill: #e0f2f1; stroke: #00695c; stroke-width: 3; filter: url(#shadow); rx: 12; }
        .box-component { fill: #ffffff; stroke: #455a64; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        .box-predict { fill: #b2dfdb; stroke: #00695c; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-tom { fill: #fce4ec; stroke: #c2185b; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-ttc { fill: #ffebee; stroke: #d32f2f; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-risk { fill: #fff3e0; stroke: #ef6c00; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-val { fill: #e8eaf6; stroke: #3f51b5; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        /* COMMON */
        .arrow { stroke: #546e7a; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-teal { stroke: #00695c; stroke-width: 2; fill: none; marker-end: url(#arrowhead-teal); }
        .arrow-out { stroke: #d32f2f; stroke-width: 3; fill: none; marker-end: url(#arrowhead-red); }
        
        .badge { fill: #263238; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
    
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#546e7a"/>
    </marker>
    <marker id="arrowhead-teal" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#00695c"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#d32f2f"/>
    </marker>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="1400" height="70" fill="#00695c"/>
<text x="700" y="35" text-anchor="middle" class="title">ENGINE 3: BEHAVIOR (PREDICTION)</text>
<text x="700" y="55" text-anchor="middle" class="subtitle">Trajectory + Acceleration • ToM + EMA • TTC + Confidence • Cross-Validation • 3ms</text>

<!-- MAIN CONTAINER -->
<rect id="engine_3_container" x="30" y="85" width="1340" height="820" class="box-main"/>

<!-- INPUT FROM ENGINE 2 -->
<g id="comp_input" transform="translate(50, 110)">
    <rect x="0" y="0" width="200" height="140" class="box-component"/>
    <text x="100" y="22" text-anchor="middle" class="label">FROM ENGINE 2</text>
    <text x="100" y="45" text-anchor="middle" class="model">tracks[]</text>
    <text x="100" y="62" text-anchor="middle" class="param">bbox3D, velocity</text>
    <text x="100" y="78" text-anchor="middle" class="param">acceleration</text>
    <text x="100" y="94" text-anchor="middle" class="param">quality_score</text>
    <text x="100" y="110" text-anchor="middle" class="param" style="fill:#c2185b">smpl_params + history</text>
    <text x="100" y="126" text-anchor="middle" class="param">intent_history</text>
</g>

<!-- ARROW: Input to Predictors -->
<line x1="250" y1="180" x2="300" y2="180" class="arrow-teal"/>

<!-- PREDICTION BLOCK -->
<g id="comp_prediction" transform="translate(300, 100)">
    <rect x="0" y="0" width="380" height="280" class="box-predict"/>
    <text x="190" y="25" text-anchor="middle" class="label" fill="#00695c">TRAJECTORY PREDICTION</text>
    
    <!-- Kinematic + Acceleration -->
    <g transform="translate(15, 45)">
        <rect x="0" y="0" width="165" height="95" rx="4" fill="#b2dfdb" stroke="#00695c"/>
        <text x="82" y="18" text-anchor="middle" class="label" style="font-size:10px" fill="#00695c">Kinematic</text>
        <text x="82" y="38" text-anchor="middle" class="model">x + v×t + ½a×t²</text>
        <text x="82" y="55" text-anchor="middle" class="param">+ acceleration</text>
        <text x="82" y="70" text-anchor="middle" class="param">3 scenarios</text>
        <rect x="42" y="78" width="80" height="14" class="badge"/>
        <text x="82" y="89" text-anchor="middle" class="badge-text">1 ms</text>
    </g>
    
    <!-- SMPL Pose + Velocity -->
    <g transform="translate(195, 45)">
        <rect x="0" y="0" width="165" height="95" rx="4" fill="#fff" stroke="#c2185b"/>
        <text x="82" y="18" text-anchor="middle" class="label" style="font-size:10px" fill="#c2185b">SMPL Pose</text>
        <text x="82" y="38" text-anchor="middle" class="model" style="fill:#c2185b">pose_velocity</text>
        <text x="82" y="55" text-anchor="middle" class="param">rotation trend</text>
        <text x="82" y="70" text-anchor="middle" class="param">PERSON only</text>
        <rect x="42" y="78" width="80" height="14" class="badge"/>
        <text x="82" y="89" text-anchor="middle" class="badge-text">&lt;1 ms</text>
    </g>
    
    <!-- Multi-modal Output -->
    <g transform="translate(15, 155)">
        <rect x="0" y="0" width="345" height="85" rx="4" fill="#fff" stroke="#00695c"/>
        <text x="172" y="18" text-anchor="middle" class="label" style="font-size:10px" fill="#00695c">MULTI-MODAL TRAJECTORIES</text>
        <text x="90" y="40" text-anchor="middle" class="param" style="fill:#2e7d32">OPTIMISTIC</text>
        <text x="172" y="40" text-anchor="middle" class="param">NOMINAL</text>
        <text x="255" y="40" text-anchor="middle" class="param" style="fill:#d32f2f">PESSIMISTIC</text>
        <text x="172" y="60" text-anchor="middle" class="param">5 timesteps × 3 scenarios = 15 predictions</text>
        <text x="172" y="75" text-anchor="middle" class="param">+ uncertainty estimation</text>
    </g>
</g>

<!-- ToM BLOCK -->
<g id="comp_tom" transform="translate(300, 410)">
    <rect x="0" y="0" width="380" height="200" class="box-tom"/>
    <text x="190" y="25" text-anchor="middle" class="label" fill="#c2185b">THEORY OF MIND (PERSON)</text>
    
    <g transform="translate(15, 45)">
        <rect x="0" y="0" width="165" height="70" rx="4" fill="#fff" stroke="#c2185b"/>
        <text x="82" y="16" text-anchor="middle" class="model" style="fill:#c2185b">Context Priors</text>
        <text x="82" y="32" text-anchor="middle" class="param">PLATFORM: P(CROSS)=5%</text>
        <text x="82" y="46" text-anchor="middle" class="param">CROSSING: P(CROSS)=25%</text>
        <text x="82" y="60" text-anchor="middle" class="param">Adaptive Bayesian</text>
    </g>
    
    <g transform="translate(195, 45)">
        <rect x="0" y="0" width="165" height="70" rx="4" fill="#fff" stroke="#c2185b"/>
        <text x="82" y="16" text-anchor="middle" class="model" style="fill:#c2185b">Temporal EMA</text>
        <text x="82" y="32" text-anchor="middle" class="param">α = 0.7</text>
        <text x="82" y="46" text-anchor="middle" class="param">Smooth intent changes</text>
        <text x="82" y="60" text-anchor="middle" class="param">Prevent oscillation</text>
    </g>
    
    <g transform="translate(15, 125)">
        <rect x="0" y="0" width="345" height="45" rx="4" fill="#fce4ec" stroke="#c2185b"/>
        <text x="172" y="18" text-anchor="middle" class="model" style="fill:#c2185b">Expanded Distraction</text>
        <text x="172" y="35" text-anchor="middle" class="param">head_down + arms_ears + irregular_gait + carrying</text>
    </g>
    
    <rect x="150" y="180" width="80" height="14" class="badge"/>
    <text x="190" y="191" text-anchor="middle" class="badge-text">1 ms</text>
</g>

<!-- CROSS-VALIDATION -->
<g id="comp_crossval" transform="translate(720, 110)">
    <rect x="0" y="0" width="280" height="120" class="box-val"/>
    <text x="140" y="25" text-anchor="middle" class="label" fill="#3f51b5">CROSS-VALIDATION</text>
    
    <g transform="translate(20, 45)">
        <rect x="0" y="0" width="240" height="55" rx="4" fill="#fff" stroke="#3f51b5"/>
        <text x="120" y="18" text-anchor="middle" class="model" style="fill:#3f51b5">Kinematic vs Optical Flow</text>
        <text x="120" y="35" text-anchor="middle" class="param">Divergence threshold: 1.5m</text>
        <text x="120" y="50" text-anchor="middle" class="param">VALIDATED | UNCERTAIN</text>
    </g>
    
    <rect x="100" y="102" width="80" height="14" class="badge"/>
    <text x="140" y="113" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- TTC BLOCK -->
<g id="comp_ttc" transform="translate(720, 260)">
    <rect x="0" y="0" width="280" height="180" class="box-ttc"/>
    <text x="140" y="25" text-anchor="middle" class="label" fill="#d32f2f">TTC CALCULATOR</text>
    
    <g transform="translate(20, 45)">
        <rect x="0" y="0" width="240" height="55" rx="4" fill="#ffcdd2" stroke="#d32f2f"/>
        <text x="120" y="18" text-anchor="middle" class="model" style="fill:#d32f2f">Confidence Intervals</text>
        <text x="120" y="35" text-anchor="middle" class="param">TTCResult: min, mean, max</text>
        <text x="120" y="50" text-anchor="middle" class="param">+ confidence [0.3, 1.0]</text>
    </g>
    
    <g transform="translate(20, 110)">
        <rect x="0" y="0" width="240" height="45" rx="4" fill="#fff" stroke="#d32f2f"/>
        <text x="120" y="18" text-anchor="middle" class="model" style="fill:#d32f2f">Early Exit</text>
        <text x="120" y="35" text-anchor="middle" class="param">If TTC &lt; 1.0s → Immediate return</text>
    </g>
    
    <rect x="100" y="162" width="80" height="14" class="badge"/>
    <text x="140" y="173" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- RISK SCORING -->
<g id="comp_risk" transform="translate(720, 470)">
    <rect x="0" y="0" width="280" height="140" class="box-risk"/>
    <text x="140" y="25" text-anchor="middle" class="label" fill="#ef6c00">RISK SCORING</text>
    
    <g transform="translate(20, 45)">
        <rect x="0" y="0" width="240" height="70" rx="4" fill="#fff" stroke="#ef6c00"/>
        <text x="120" y="18" text-anchor="middle" class="model" style="fill:#ef6c00">Weighted + Quality</text>
        <text x="120" y="35" text-anchor="middle" class="param">TTC(35%) + Intent(25%)</text>
        <text x="120" y="50" text-anchor="middle" class="param">Distract(15%) + Cat(10%)</text>
        <text x="120" y="65" text-anchor="middle" class="param">+ Quality(15%)</text>
    </g>
    
    <rect x="100" y="122" width="80" height="14" class="badge"/>
    <text x="140" y="133" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- OUTPUT TO SAFETY VETO -->
<g id="comp_output" transform="translate(1040, 260)">
    <rect x="0" y="0" width="280" height="350" class="box-component" style="stroke:#d32f2f;stroke-width:3"/>
    <text x="140" y="25" text-anchor="middle" class="label" fill="#d32f2f">TO SAFETY VETO</text>
    
    <rect x="20" y="50" width="240" height="40" rx="4" fill="#e0f2f1" stroke="#00695c"/>
    <text x="140" y="75" text-anchor="middle" class="model">predictions[] (multi-modal)</text>
    
    <rect x="20" y="100" width="240" height="40" rx="4" fill="#ffebee" stroke="#d32f2f"/>
    <text x="140" y="118" text-anchor="middle" class="model" style="fill:#d32f2f">ttc_result</text>
    <text x="140" y="132" text-anchor="middle" class="param">min, mean, max, confidence</text>
    
    <rect x="20" y="150" width="240" height="35" rx="4" fill="#fff3e0" stroke="#ef6c00"/>
    <text x="140" y="172" text-anchor="middle" class="model" style="fill:#ef6c00">risk_scores{}</text>
    
    <rect x="20" y="195" width="240" height="35" rx="4" fill="#e0f2f1" stroke="#00695c"/>
    <text x="140" y="217" text-anchor="middle" class="param">safety_margin (dynamic)</text>
    
    <rect x="20" y="240" width="240" height="40" rx="4" fill="#e8eaf6" stroke="#3f51b5"/>
    <text x="140" y="258" text-anchor="middle" class="model" style="fill:#3f51b5">validation_status</text>
    <text x="140" y="272" text-anchor="middle" class="param">VALIDATED | UNCERTAIN</text>
    
    <rect x="20" y="290" width="240" height="50" rx="4" fill="#fff" stroke="#d32f2f"/>
    <text x="140" y="310" text-anchor="middle" class="param" style="fill:#d32f2f">&lt;1s: EMERGENCY BRAKE</text>
    <text x="140" y="325" text-anchor="middle" class="param" style="fill:#d32f2f">UNCERTAIN: Conservative action</text>
</g>

<!-- ARROWS -->
<path d="M 680 250 L 720 250" class="arrow-teal"/>
<path d="M 490 380 L 490 410" class="arrow-teal"/>
<path d="M 680 510 L 720 510" class="arrow"/>
<path d="M 1000 350 L 1040 350" class="arrow-out"/>
<path d="M 1000 540 L 1010 540 L 1010 450 L 1040 450" class="arrow"/>
<path d="M 1000 170 L 1010 170 L 1010 310 L 1040 310" class="arrow"/>

<!-- LEGEND -->
<g transform="translate(50, 820)">
    <text x="0" y="15" class="label">COMPONENTS:</text>
    <rect x="120" y="3" width="18" height="18" class="box-predict"/>
    <text x="145" y="17" class="detail">Trajectory</text>
    <rect x="210" y="3" width="18" height="18" class="box-tom"/>
    <text x="235" y="17" class="detail">ToM</text>
    <rect x="270" y="3" width="18" height="18" class="box-ttc"/>
    <text x="295" y="17" class="detail">TTC</text>
    <rect x="330" y="3" width="18" height="18" class="box-risk"/>
    <text x="355" y="17" class="detail">Risk</text>
    <rect x="400" y="3" width="18" height="18" class="box-val"/>
    <text x="425" y="17" class="detail">Validation</text>
</g>

<!-- TOTAL TIMING -->
<g transform="translate(1150, 820)">
    <rect x="0" y="0" width="180" height="50" rx="6" fill="#263238"/>
    <text x="90" y="20" text-anchor="middle" class="badge-text" style="font-size:14px">TOTAL: 3 ms</text>
    <text x="90" y="38" text-anchor="middle" class="badge-text" style="font-size:9px">1+1+&lt;1+&lt;1 ms</text>
</g>

</svg>
