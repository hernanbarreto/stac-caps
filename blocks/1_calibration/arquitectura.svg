<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1300" height="700" viewBox="0 0 1300 700">
<defs>
    <!-- GLOBAL FILTERS -->
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.15"/>
    </filter>

    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#546e7a"/>
    </marker>

    <style>
        /* FONTS */
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #212121; }
        .title { font-weight: 800; font-size: 22px; fill: #ffffff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-weight: 700; font-size: 14px; fill: #e65100; }
        .detail { font-size: 11px; fill: #455a64; }
        .model { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; font-weight: 600; fill: #e65100; }
        .param { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #f57f17; }
        
        /* BOXES mapped to Standard Palette */
        /* Main Calibration Layer -> Yellow/Orange */
        .box-main { fill: #fffde7; stroke: #fbc02d; stroke-width: 3; filter: url(#shadow); rx: 12; }
        
        /* Stages -> White with Orange Stroke */
        .box-stage { fill: #ffffff; stroke: #ef6c00; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        /* Fallback -> Red Safety */
        .box-fallback { fill: #ffebee; stroke: #c62828; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        /* Output -> Green/Success */
        .box-output { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        /* COMMON */
        .arrow { stroke: #546e7a; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .badge { fill: #263238; rx: 4; }
        .badge-human { fill: #7b1fa2; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="1300" height="70" fill="#f57f17"/>
<text x="650" y="35" text-anchor="middle" class="title">LAYER 1: CALIBRATION &amp; LOCALIZATION</text>
<text x="650" y="55" text-anchor="middle" class="subtitle">Rail Geometry • Landmarks • Occlusion Fallback • Metric Scale</text>

<!-- MAIN CONTAINER -->
<rect x="30" y="85" width="1240" height="580" class="box-main"/>

<!-- STAGE 1: HARD INIT -->
<g transform="translate(50, 110)">
    <rect x="0" y="0" width="350" height="250" class="box-stage"/>
    <text x="175" y="25" text-anchor="middle" class="label" fill="#ef6c00">STAGE 1: HARD INITIALIZATION</text>
    <rect x="125" y="35" width="100" height="18" class="badge-human"/>
    <text x="175" y="48" text-anchor="middle" class="badge-text">HUMAN-IN-LOOP</text>
    
    <rect x="20" y="65" width="310" height="50" rx="4" fill="#fff3e0" stroke="#ef6c00"/>
    <text x="175" y="85" text-anchor="middle" class="model">Operator Selects Rail Heads</text>
    <text x="175" y="100" text-anchor="middle" class="param">Two clicks on visible rails</text>
    
    <rect x="20" y="125" width="310" height="50" rx="4" fill="#fff3e0" stroke="#ef6c00"/>
    <text x="175" y="145" text-anchor="middle" class="model">Ground Truth: 1435mm</text>
    <text x="175" y="160" text-anchor="middle" class="param">Standard gauge = metric scale</text>
    
    <rect x="20" y="185" width="310" height="40" rx="4" fill="#e8f5e9" stroke="#2e7d32"/>
    <text x="175" y="205" text-anchor="middle" class="model" style="fill:#2e7d32">OUTPUT: extrinsics + scale_factor</text>
    <text x="175" y="218" text-anchor="middle" class="param" style="fill:#2e7d32">confidence: 0.99</text>
</g>

<!-- STAGE 2: ONLINE LEARNING -->
<g transform="translate(450, 110)">
    <rect x="0" y="0" width="350" height="250" class="box-stage"/>
    <text x="175" y="25" text-anchor="middle" class="label" fill="#ef6c00">STAGE 2: ONLINE LEARNING</text>
    <rect x="110" y="35" width="130" height="18" class="badge"/>
    <text x="175" y="48" text-anchor="middle" class="badge-text">CONTINUOUS</text>
    
    <rect x="20" y="65" width="310" height="50" rx="4" fill="#fff3e0" stroke="#ef6c00"/>
    <text x="175" y="85" text-anchor="middle" class="model">SuperPoint Keypoints</text>
    <text x="175" y="100" text-anchor="middle" class="param">Detect stable landmarks</text>
    
    <rect x="20" y="125" width="310" height="50" rx="4" fill="#fff3e0" stroke="#ef6c00"/>
    <text x="175" y="145" text-anchor="middle" class="model">Landmark Database</text>
    <text x="175" y="160" text-anchor="middle" class="param">LRU cache (max 1000)</text>
    
    <rect x="20" y="185" width="310" height="40" rx="4" fill="#e8f5e9" stroke="#2e7d32"/>
    <text x="175" y="205" text-anchor="middle" class="model" style="fill:#2e7d32">Refine extrinsics (PnP)</text>
    <text x="175" y="218" text-anchor="middle" class="param" style="fill:#2e7d32">Handle drift</text>
</g>

<!-- STAGE 3: FALLBACK -->
<g transform="translate(850, 110)">
    <rect x="0" y="0" width="350" height="250" class="box-fallback"/>
    <text x="175" y="25" text-anchor="middle" class="label" fill="#d32f2f">STAGE 3: ROBUST FALLBACK</text>
    <rect x="100" y="35" width="150" height="18" class="badge" style="fill:#d32f2f"/>
    <text x="175" y="48" text-anchor="middle" class="badge-text">OCCLUSION MODE</text>
    
    <rect x="20" y="65" width="310" height="50" rx="4" fill="#ffebee" stroke="#d32f2f"/>
    <text x="175" y="85" text-anchor="middle" class="model" style="fill:#d32f2f">IF Rails Hidden</text>
    <text x="175" y="100" text-anchor="middle" class="param" style="fill:#d32f2f">(e.g., by passing train)</text>
    
    <rect x="20" y="125" width="310" height="50" rx="4" fill="#ffebee" stroke="#d32f2f"/>
    <text x="175" y="145" text-anchor="middle" class="model" style="fill:#d32f2f">Switch → Landmark Mode</text>
    <text x="175" y="160" text-anchor="middle" class="param" style="fill:#d32f2f">Use stored keypoints only</text>
    
    <rect x="20" y="185" width="310" height="40" rx="4" fill="#fff" stroke="#d32f2f"/>
    <text x="175" y="205" text-anchor="middle" class="model" style="fill:#d32f2f">ZERO DRIFT GUARANTEE</text>
    <text x="175" y="218" text-anchor="middle" class="param" style="fill:#d32f2f">Maintains 6DoF pose</text>
</g>

<!-- ARROWS between stages -->
<line x1="400" y1="235" x2="450" y2="235" class="arrow"/>
<line x1="800" y1="235" x2="850" y2="235" class="arrow" style="stroke:#d32f2f"/>

<!-- OUTPUT SECTION -->
<g transform="translate(300, 400)">
    <rect x="0" y="0" width="700" height="150" class="box-output"/>
    <text x="350" y="25" text-anchor="middle" class="label" fill="#2e7d32">CALIBRATION OUTPUT</text>
    
    <rect x="30" y="45" width="190" height="40" rx="4" fill="#fff" stroke="#2e7d32"/>
    <text x="125" y="70" text-anchor="middle" class="model" style="fill:#2e7d32">intrinsics [3×3]</text>
    
    <rect x="250" y="45" width="190" height="40" rx="4" fill="#fff" stroke="#2e7d32"/>
    <text x="345" y="70" text-anchor="middle" class="model" style="fill:#2e7d32">extrinsics (R, t)</text>
    
    <rect x="470" y="45" width="190" height="40" rx="4" fill="#fff" stroke="#2e7d32"/>
    <text x="565" y="70" text-anchor="middle" class="model" style="fill:#2e7d32">scale_factor</text>
    
    <text x="350" y="115" text-anchor="middle" class="detail" fill="#2e7d32">→ Engine 1A (depth scale) | Engine 1B (projection) | 3D Fusion (world coords)</text>
    <rect x="285" y="125" width="130" height="18" class="badge" style="fill:#2e7d32"/>
    <text x="350" y="138" text-anchor="middle" class="badge-text">PARALLEL (0ms added)</text>
</g>

<!-- Legend -->
<g transform="translate(50, 590)">
    <text x="0" y="15" class="label">STAGES:</text>
    <rect x="100" y="3" width="18" height="18" class="badge-human"/>
    <text x="125" y="17" class="detail">Human Init</text>
    <rect x="200" y="3" width="18" height="18" class="box-stage"/>
    <text x="225" y="17" class="detail">Online</text>
    <rect x="280" y="3" width="18" height="18" class="box-fallback"/>
    <text x="305" y="17" class="detail">Fallback</text>
</g>

</svg>
