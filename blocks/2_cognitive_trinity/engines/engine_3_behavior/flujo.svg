<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1100" height="1550" viewBox="0 0 1100 1550">
<defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.12"/>
    </filter>
    
    <style>
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #263238; }
        .title { font-size: 22px; font-weight: 800; fill: #fff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-size: 13px; font-weight: 700; fill: #000; }
        .detail { font-size: 11px; fill: #455a64; }
        .code { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #004d40; }
        
        .box-step { fill: #ffffff; stroke: #455a64; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-process { fill: #e0f2f1; stroke: #00695c; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-tom { fill: #fce4ec; stroke: #c2185b; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-decision { fill: #fff8e1; stroke: #f57f17; stroke-width: 2; filter: url(#shadow); rx: 4; }
        .box-ttc { fill: #ffebee; stroke: #d32f2f; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-val { fill: #e8eaf6; stroke: #3f51b5; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-risk { fill: #fff3e0; stroke: #ef6c00; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        .arrow { stroke: #546e7a; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-teal { stroke: #00695c; stroke-width: 2; fill: none; marker-end: url(#arrowhead-teal); }
        .arrow-pink { stroke: #c2185b; stroke-width: 2; fill: none; marker-end: url(#arrowhead-pink); }
        .arrow-red { stroke: #d32f2f; stroke-width: 2; fill: none; marker-end: url(#arrowhead-red); }
        .arrow-blue { stroke: #3f51b5; stroke-width: 2; fill: none; marker-end: url(#arrowhead-blue); }
        
        .badge { fill: #263238; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
    
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#546e7a"/>
    </marker>
    <marker id="arrowhead-teal" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#00695c"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#d32f2f"/>
    </marker>
    <marker id="arrowhead-pink" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#c2185b"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#3f51b5"/>
    </marker>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="1100" height="70" fill="#00695c"/>
<text x="550" y="35" text-anchor="middle" class="title">ENGINE 3: BEHAVIOR FLOW</text>
<text x="550" y="55" text-anchor="middle" class="subtitle">Acceleration • EMA • Confidence Intervals • Cross-Validation • 3ms</text>

<!-- STEP 1: INPUT -->
<g transform="translate(400, 100)">
    <rect x="0" y="0" width="300" height="80" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">1. RECEIVE TRACKS</text>
    <text x="150" y="48" text-anchor="middle" class="code">tracks[] from Engine 2</text>
    <text x="150" y="65" text-anchor="middle" class="detail">+ acceleration, smpl_history, intent_history, scene_context</text>
</g>
<line x1="550" y1="180" x2="550" y2="210" class="arrow-teal"/>

<!-- STEP 2: KINEMATIC -->
<g transform="translate(350, 210)">
    <rect x="0" y="0" width="400" height="100" class="box-process"/>
    <text x="200" y="25" text-anchor="middle" class="label" fill="#00695c">2. KINEMATIC TRAJECTORY</text>
    
    <g transform="translate(20, 40)">
        <rect x="0" y="0" width="360" height="40" rx="4" fill="#b2dfdb" stroke="#00695c"/>
        <text x="180" y="18" text-anchor="middle" class="code">x(t) = x₀ + v×t + ½×a×t²</text>
        <text x="180" y="32" text-anchor="middle" class="detail">3 scenarios: optimistic / nominal / pessimistic</text>
    </g>
    
    <rect x="160" y="85" width="80" height="12" class="badge"/>
    <text x="200" y="94" text-anchor="middle" class="badge-text">1 ms</text>
</g>
<line x1="550" y1="310" x2="550" y2="340" class="arrow-teal"/>

<!-- DECISION: PERSON? -->
<g transform="translate(450, 340)">
    <polygon points="100,0 200,40 100,80 0,40" class="box-decision"/>
    <text x="100" y="35" text-anchor="middle" class="label">PERSON?</text>
    <text x="100" y="52" text-anchor="middle" class="detail">category</text>
</g>

<!-- YES: SMPL + ToM -->
<line x1="550" y1="420" x2="550" y2="450" class="arrow-pink"/>
<text x="570" y="440" class="detail" fill="#c2185b">Yes</text>

<!-- NO: Skip to Cross-Validation -->
<path d="M 650 380 L 800 380 L 800 770 L 750 770" class="arrow" style="stroke:#455a64"/>
<text x="670" y="370" class="detail">No: Skip ToM</text>

<!-- STEP 3: SMPL POSE -->
<g transform="translate(350, 450)">
    <rect x="0" y="0" width="400" height="90" class="box-tom"/>
    <text x="200" y="25" text-anchor="middle" class="label" fill="#c2185b">3. SMPL POSE ANALYSIS</text>
    
    <g transform="translate(20, 38)">
        <rect x="0" y="0" width="360" height="32" rx="4" fill="#fff" stroke="#c2185b"/>
        <text x="180" y="15" text-anchor="middle" class="code" style="fill:#c2185b">pose_velocity = (pose[t] - pose[t-1]) / dt</text>
        <text x="180" y="26" text-anchor="middle" class="detail">Predict rotation toward track (rotating_towards)</text>
    </g>
    
    <rect x="160" y="75" width="80" height="12" class="badge"/>
    <text x="200" y="84" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>
<line x1="550" y1="540" x2="550" y2="570" class="arrow-pink"/>

<!-- STEP 4: ToM -->
<g transform="translate(300, 570)">
    <rect x="0" y="0" width="500" height="160" class="box-tom"/>
    <text x="250" y="25" text-anchor="middle" class="label" fill="#c2185b">4. THEORY OF MIND</text>
    
    <g transform="translate(15, 42)">
        <rect x="0" y="0" width="225" height="55" rx="4" fill="#fff" stroke="#c2185b"/>
        <text x="112" y="18" text-anchor="middle" class="code" style="fill:#c2185b">Context Priors</text>
        <text x="112" y="35" text-anchor="middle" class="detail">PLATFORM: P(CROSS)=5%</text>
        <text x="112" y="48" text-anchor="middle" class="detail">CROSSING: P(CROSS)=25%</text>
    </g>
    
    <g transform="translate(255, 42)">
        <rect x="0" y="0" width="225" height="55" rx="4" fill="#fff" stroke="#c2185b"/>
        <text x="112" y="18" text-anchor="middle" class="code" style="fill:#c2185b">Temporal EMA</text>
        <text x="112" y="35" text-anchor="middle" class="detail">α = 0.7 smoothing</text>
        <text x="112" y="48" text-anchor="middle" class="detail">Prevent oscillation</text>
    </g>
    
    <g transform="translate(15, 107)">
        <rect x="0" y="0" width="465" height="28" rx="4" fill="#fce4ec" stroke="#c2185b"/>
        <text x="232" y="18" text-anchor="middle" class="code" style="fill:#c2185b">distraction = head_down + ears + gait + carrying</text>
    </g>
    
    <rect x="210" y="143" width="80" height="12" class="badge"/>
    <text x="250" y="152" text-anchor="middle" class="badge-text">1 ms</text>
</g>
<line x1="550" y1="730" x2="550" y2="760" class="arrow-blue"/>

<!-- STEP 5: CROSS-VALIDATION -->
<g transform="translate(350, 760)">
    <rect x="0" y="0" width="400" height="85" class="box-val"/>
    <text x="200" y="25" text-anchor="middle" class="label" fill="#3f51b5">5. CROSS-VALIDATION</text>
    
    <g transform="translate(20, 38)">
        <rect x="0" y="0" width="360" height="30" rx="4" fill="#fff" stroke="#3f51b5"/>
        <text x="180" y="15" text-anchor="middle" class="code" style="fill:#3f51b5">kinematic_velocity vs optical_flow</text>
        <text x="180" y="26" text-anchor="middle" class="detail">Divergence &gt;1.5m → UNCERTAIN</text>
    </g>
    
    <rect x="160" y="72" width="80" height="10" class="badge"/>
    <text x="200" y="80" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>
<line x1="550" y1="845" x2="550" y2="875" class="arrow-red"/>

<!-- STEP 6: TTC -->
<g transform="translate(300, 875)">
    <rect x="0" y="0" width="500" height="110" class="box-ttc"/>
    <text x="250" y="25" text-anchor="middle" class="label" fill="#d32f2f">6. TTC CALCULATION</text>
    
    <g transform="translate(15, 40)">
        <rect x="0" y="0" width="225" height="45" rx="4" fill="#ffcdd2" stroke="#d32f2f"/>
        <text x="112" y="18" text-anchor="middle" class="code" style="fill:#d32f2f">Confidence Intervals</text>
        <text x="112" y="35" text-anchor="middle" class="detail">TTCResult: min, mean, max</text>
    </g>
    
    <g transform="translate(255, 40)">
        <rect x="0" y="0" width="225" height="45" rx="4" fill="#fff" stroke="#d32f2f"/>
        <text x="112" y="18" text-anchor="middle" class="code" style="fill:#d32f2f">Early Exit</text>
        <text x="112" y="35" text-anchor="middle" class="detail">If TTC &lt;1s → immediate return</text>
    </g>
    
    <rect x="210" y="92" width="80" height="12" class="badge"/>
    <text x="250" y="101" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>
<line x1="550" y1="985" x2="550" y2="1015" class="arrow"/>

<!-- STEP 7: RISK -->
<g transform="translate(350, 1015)">
    <rect x="0" y="0" width="400" height="90" rx="6" fill="#fff3e0" stroke="#ef6c00" stroke-width="2" filter="url(#shadow)"/>
    <text x="200" y="25" text-anchor="middle" class="label" fill="#ef6c00">7. RISK SCORING</text>
    
    <g transform="translate(20, 38)">
        <rect x="0" y="0" width="360" height="35" rx="4" fill="#fff" stroke="#ef6c00"/>
        <text x="180" y="15" text-anchor="middle" class="code" style="fill:#ef6c00">risk = TTC×0.35 + Intent×0.25 + Distract×0.15 + Cat×0.10 + Quality×0.15</text>
        <text x="180" y="28" text-anchor="middle" class="detail">Temporal smoothing + confidence adjustment</text>
    </g>
    
    <rect x="160" y="77" width="80" height="10" class="badge"/>
    <text x="200" y="85" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>
<line x1="550" y1="1105" x2="550" y2="1135" class="arrow"/>

<!-- STEP 8: SAFETY MARGIN -->
<g transform="translate(350, 1135)">
    <rect x="0" y="0" width="400" height="65" class="box-process"/>
    <text x="200" y="22" text-anchor="middle" class="label" fill="#00695c">8. DYNAMIC SAFETY MARGIN</text>
    <text x="200" y="42" text-anchor="middle" class="code">margin = base × intent_mult × distraction_factor</text>
    <text x="200" y="57" text-anchor="middle" class="detail">CROSSING+DISTRACTED: 5m × 2.0 × 1.25 = 12.5m</text>
</g>
<line x1="550" y1="1200" x2="550" y2="1230" class="arrow-red"/>

<!-- OUTPUT -->
<g transform="translate(300, 1230)">
    <rect x="0" y="0" width="500" height="130" class="box-step" style="stroke:#d32f2f;stroke-width:3"/>
    <text x="250" y="25" text-anchor="middle" class="label" fill="#d32f2f">OUTPUT → SAFETY VETO</text>
    
    <rect x="25" y="45" width="135" height="30" rx="4" fill="#e0f2f1" stroke="#00695c"/>
    <text x="92" y="65" text-anchor="middle" class="code">predictions[]</text>
    
    <rect x="175" y="45" width="150" height="30" rx="4" fill="#ffebee" stroke="#d32f2f"/>
    <text x="250" y="58" text-anchor="middle" class="code" style="fill:#d32f2f">ttc_result</text>
    <text x="250" y="70" text-anchor="middle" class="detail">(min,mean,max,conf)</text>
    
    <rect x="340" y="45" width="135" height="30" rx="4" fill="#fff3e0" stroke="#ef6c00"/>
    <text x="407" y="65" text-anchor="middle" class="code" style="fill:#ef6c00">risk_scores{}</text>
    
    <rect x="25" y="90" width="135" height="25" rx="4" fill="#e0f2f1" stroke="#00695c"/>
    <text x="92" y="107" text-anchor="middle" class="detail">safety_margin</text>
    
    <rect x="175" y="90" width="150" height="25" rx="4" fill="#e8eaf6" stroke="#3f51b5"/>
    <text x="250" y="107" text-anchor="middle" class="code" style="fill:#3f51b5">validation_status</text>
    
    <rect x="340" y="90" width="135" height="25" rx="4" fill="#ffebee" stroke="#d32f2f"/>
    <text x="407" y="107" text-anchor="middle" class="detail" style="fill:#d32f2f">&lt;1s: BRAKE</text>
</g>

<!-- TOTAL TIMING -->
<g transform="translate(850, 1450)">
    <rect x="0" y="0" width="200" height="50" rx="6" fill="#263238"/>
    <text x="100" y="20" text-anchor="middle" class="badge-text" style="font-size:14px">TOTAL: 3 ms</text>
    <text x="100" y="38" text-anchor="middle" class="badge-text" style="font-size:9px">1+1+&lt;1+&lt;1 ms</text>
</g>

</svg>
