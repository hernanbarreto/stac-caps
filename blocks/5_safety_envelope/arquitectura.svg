<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1300" height="850" viewBox="0 0 1300 850">
<defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.15"/>
    </filter>
    
    <style>
        /* FONTS */
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #212121; }
        .title { font-weight: 800; font-size: 22px; fill: #ffffff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-weight: 700; font-size: 14px; fill: #000; }
        .detail { font-size: 11px; fill: #455a64; }
        .model { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; font-weight: 600; fill: #b71c1c; }
        .param { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #c62828; }
        
        /* BOXES */
        .box-main { fill: #ffebee; stroke: #d32f2f; stroke-width: 3; filter: url(#shadow); rx: 12; }
        .box-component { fill: #ffffff; stroke: #455a64; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        .box-eval { fill: #fff3e0; stroke: #ef6c00; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-decision { fill: #ffebee; stroke: #d32f2f; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-hardware { fill: #b71c1c; stroke: #7f0000; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-output { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        /* COMMON */
        .arrow { stroke: #455a64; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-red { stroke: #d32f2f; stroke-width: 3; fill: none; marker-end: url(#arrowhead-red); }
        .arrow-green { stroke: #2e7d32; stroke-width: 2; fill: none; marker-end: url(#arrowhead-green); }
        
        .badge { fill: #263238; rx: 4; }
        .badge-red { fill: #b71c1c; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
    
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#546e7a"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#d32f2f"/>
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#2e7d32"/>
    </marker>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="1300" height="70" fill="#d32f2f"/>
<text x="650" y="35" text-anchor="middle" class="title">SAFETY VETO</text>
<text x="650" y="55" text-anchor="middle" class="subtitle">TTC Decision • Risk Aggregation • Hardwire Brake • ISO 26262 • 7ms Budget</text>

<!-- MAIN CONTAINER -->
<rect id="safety_container" x="30" y="85" width="1240" height="720" class="box-main"/>

<!-- INPUT FROM ENGINE 3 -->
<g id="comp_input" transform="translate(50, 110)">
    <rect x="0" y="0" width="200" height="160" class="box-component"/>
    <text x="100" y="22" text-anchor="middle" class="label">FROM ENGINE 3</text>
    <text x="100" y="45" text-anchor="middle" class="model">ttc_result</text>
    <text x="100" y="60" text-anchor="middle" class="param">(min, mean, max, conf)</text>
    <text x="100" y="80" text-anchor="middle" class="model">risk_scores{}</text>
    <text x="100" y="95" text-anchor="middle" class="model">predictions[]</text>
    <text x="100" y="110" text-anchor="middle" class="model">safety_margin</text>
    <text x="100" y="125" text-anchor="middle" class="model">validation_status</text>
    <text x="100" y="142" text-anchor="middle" class="param">VALIDATED | UNCERTAIN</text>
</g>

<!-- ARROW -->
<line x1="250" y1="190" x2="300" y2="190" class="arrow-red"/>

<!-- TTC EVALUATOR -->
<g id="comp_ttc_eval" transform="translate(300, 110)">
    <rect x="0" y="0" width="280" height="160" class="box-eval"/>
    <text x="140" y="25" text-anchor="middle" class="label" fill="#ef6c00">TTC EVALUATOR</text>
    
    <g transform="translate(15, 45)">
        <rect x="0" y="0" width="250" height="70" rx="4" fill="#fff" stroke="#ef6c00"/>
        <text x="125" y="18" text-anchor="middle" class="model" style="fill:#ef6c00">Confidence-based Selection</text>
        <text x="125" y="38" text-anchor="middle" class="param">UNCERTAIN → use TTC.min</text>
        <text x="125" y="52" text-anchor="middle" class="param">conf &lt; 0.7 → use TTC.min</text>
        <text x="125" y="66" text-anchor="middle" class="param">otherwise → use TTC.mean</text>
    </g>
    
    <rect x="100" y="130" width="80" height="18" class="badge"/>
    <text x="140" y="143" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- RISK AGGREGATOR -->
<g id="comp_risk_agg" transform="translate(300, 290)">
    <rect x="0" y="0" width="280" height="120" class="box-eval"/>
    <text x="140" y="25" text-anchor="middle" class="label" fill="#ef6c00">RISK AGGREGATOR</text>
    
    <g transform="translate(15, 45)">
        <rect x="0" y="0" width="250" height="45" rx="4" fill="#fff" stroke="#ef6c00"/>
        <text x="125" y="18" text-anchor="middle" class="model" style="fill:#ef6c00">max_risk = max(risk_scores)</text>
        <text x="125" y="35" text-anchor="middle" class="param">critical_count = count(r &gt; 0.8)</text>
    </g>
    
    <rect x="100" y="98" width="80" height="14" class="badge"/>
    <text x="140" y="109" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- ARROWS to Decision -->
<path d="M 580 190 L 630 190 L 630 300 L 680 300" class="arrow"/>
<path d="M 580 350 L 630 350 L 630 300 L 680 300" class="arrow"/>

<!-- DECISION ENGINE -->
<g id="comp_decision" transform="translate(680, 130)">
    <rect x="0" y="0" width="320" height="340" class="box-decision"/>
    <text x="160" y="25" text-anchor="middle" class="label" fill="#d32f2f">DECISION ENGINE</text>
    
    <!-- TTC < 1.0s -->
    <g transform="translate(20, 45)">
        <polygon points="70,0 140,25 70,50 0,25" fill="#d32f2f" stroke="#b71c1c" stroke-width="2"/>
        <text x="70" y="22" text-anchor="middle" class="badge-text" style="font-size:10px">TTC &lt; 1.0s?</text>
        <text x="70" y="35" text-anchor="middle" class="badge-text" style="font-size:8px">or crit &gt;= 3</text>
        
        <rect x="170" y="5" width="110" height="40" fill="#b71c1c" stroke="#7f0000" rx="4"/>
        <text x="225" y="22" text-anchor="middle" class="badge-text" style="font-size:10px">EMERGENCY</text>
        <text x="225" y="35" text-anchor="middle" class="badge-text" style="font-size:8px">BRAKE</text>
        <line x1="140" y1="25" x2="170" y2="25" stroke="#b71c1c" stroke-width="2"/>
    </g>
    
    <!-- TTC < 3.0s -->
    <g transform="translate(20, 115)">
        <polygon points="70,0 140,25 70,50 0,25" fill="#ff9800" stroke="#ef6c00" stroke-width="2"/>
        <text x="70" y="28" text-anchor="middle" fill="#fff" style="font-size:10px;font-weight:700">TTC &lt; 3.0s?</text>
        
        <rect x="170" y="5" width="110" height="40" fill="#ff9800" stroke="#ef6c00" rx="4"/>
        <text x="225" y="28" text-anchor="middle" class="badge-text" style="font-size:10px">WARNING</text>
        <line x1="140" y1="25" x2="170" y2="25" stroke="#ef6c00" stroke-width="2"/>
    </g>
    
    <!-- TTC < 5.0s -->
    <g transform="translate(20, 185)">
        <polygon points="70,0 140,25 70,50 0,25" fill="#ffeb3b" stroke="#f9a825" stroke-width="2"/>
        <text x="70" y="28" text-anchor="middle" fill="#333" style="font-size:10px;font-weight:700">TTC &lt; 5.0s?</text>
        
        <rect x="170" y="5" width="110" height="40" fill="#fff9c4" stroke="#f9a825" rx="4"/>
        <text x="225" y="28" text-anchor="middle" fill="#333" style="font-size:10px;font-weight:700">CAUTION</text>
        <line x1="140" y1="25" x2="170" y2="25" stroke="#f9a825" stroke-width="2"/>
    </g>
    
    <!-- CLEAR -->
    <g transform="translate(20, 255)">
        <polygon points="70,0 140,25 70,50 0,25" fill="#4caf50" stroke="#2e7d32" stroke-width="2"/>
        <text x="70" y="28" text-anchor="middle" fill="#fff" style="font-size:10px;font-weight:700">TTC &gt; 5.0s</text>
        
        <rect x="170" y="5" width="110" height="40" fill="#c8e6c9" stroke="#2e7d32" rx="4"/>
        <text x="225" y="28" text-anchor="middle" fill="#1b5e20" style="font-size:10px;font-weight:700">CLEAR</text>
        <line x1="140" y1="25" x2="170" y2="25" stroke="#2e7d32" stroke-width="2"/>
    </g>
    
    <rect x="120" y="315" width="80" height="18" class="badge"/>
    <text x="160" y="328" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- HARDWIRE CONTROLLER -->
<g id="comp_hardwire" transform="translate(1050, 130)">
    <rect x="0" y="0" width="180" height="140" class="box-hardware"/>
    <text x="90" y="25" text-anchor="middle" class="badge-text" style="font-size:13px">HARDWIRE</text>
    <text x="90" y="42" text-anchor="middle" class="badge-text" style="font-size:13px">CONTROLLER</text>
    
    <g transform="translate(15, 55)">
        <rect x="0" y="0" width="150" height="55" rx="4" fill="#7f0000" stroke="#b71c1c"/>
        <text x="75" y="20" text-anchor="middle" class="badge-text">GPIO_BRAKE_RELAY</text>
        <text x="75" y="38" text-anchor="middle" class="badge-text" style="font-size:8px">Direct Hardware</text>
        <text x="75" y="50" text-anchor="middle" class="badge-text" style="font-size:8px">Bypass Software</text>
    </g>
    
    <rect x="50" y="118" width="80" height="16" class="badge-red"/>
    <text x="90" y="130" text-anchor="middle" class="badge-text">&lt;0.5 ms</text>
</g>

<!-- Arrow to Hardwire -->
<path d="M 1000 175 L 1050 175" class="arrow-red"/>

<!-- OUTPUT BLOCK -->
<g id="comp_output" transform="translate(680, 500)">
    <rect x="0" y="0" width="320" height="180" class="box-output"/>
    <text x="160" y="25" text-anchor="middle" class="label" fill="#2e7d32">OUTPUT SIGNALS</text>
    
    <g transform="translate(20, 45)">
        <rect x="0" y="0" width="130" height="50" rx="4" fill="#fff" stroke="#2e7d32"/>
        <text x="65" y="20" text-anchor="middle" class="model" style="fill:#2e7d32">CAN Bus</text>
        <text x="65" y="38" text-anchor="middle" class="param">brake_cmd (0-100%)</text>
    </g>
    
    <g transform="translate(165, 45)">
        <rect x="0" y="0" width="130" height="50" rx="4" fill="#fff" stroke="#2e7d32"/>
        <text x="65" y="20" text-anchor="middle" class="model" style="fill:#2e7d32">MQTT Alert</text>
        <text x="65" y="38" text-anchor="middle" class="param">alert_level (0-3)</text>
    </g>
    
    <g transform="translate(20, 110)">
        <rect x="0" y="0" width="275" height="45" rx="4" fill="#fff" stroke="#2e7d32"/>
        <text x="137" y="18" text-anchor="middle" class="model" style="fill:#2e7d32">SCADA Output</text>
        <text x="137" y="35" text-anchor="middle" class="param">action, brake_command, audit_log</text>
    </g>
    
    <rect x="120" y="162" width="80" height="14" class="badge"/>
    <text x="160" y="173" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- Arrow to Output -->
<path d="M 840 470 L 840 500" class="arrow-green"/>

<!-- AUDIT LOGGER -->
<g id="comp_audit" transform="translate(1050, 300)">
    <rect x="0" y="0" width="180" height="130" class="box-component"/>
    <text x="90" y="22" text-anchor="middle" class="label">AUDIT LOGGER</text>
    
    <g transform="translate(15, 40)">
        <rect x="0" y="0" width="150" height="60" rx="4" fill="#e8eaf6" stroke="#3f51b5"/>
        <text x="75" y="18" text-anchor="middle" class="model" style="fill:#3f51b5">ISO 26262</text>
        <text x="75" y="35" text-anchor="middle" class="param">Traceability Log</text>
        <text x="75" y="50" text-anchor="middle" class="param">Secure, Timestamped</text>
    </g>
    
    <rect x="50" y="108" width="80" height="14" class="badge"/>
    <text x="90" y="119" text-anchor="middle" class="badge-text">async</text>
</g>

<!-- Arrow to Audit -->
<path d="M 1000 300 L 1050 300" class="arrow"/>

<!-- LEGEND -->
<g transform="translate(50, 720)">
    <text x="0" y="15" class="label">COMPONENTS:</text>
    <rect x="120" y="3" width="18" height="18" class="box-eval"/>
    <text x="145" y="17" class="detail">Evaluation</text>
    <rect x="210" y="3" width="18" height="18" class="box-decision"/>
    <text x="235" y="17" class="detail">Decision</text>
    <rect x="300" y="3" width="18" height="18" class="box-hardware"/>
    <text x="325" y="17" class="detail" fill="#fff">Hardwire</text>
    <rect x="390" y="3" width="18" height="18" class="box-output"/>
    <text x="415" y="17" class="detail">Output</text>
</g>

<!-- TOTAL TIMING -->
<g transform="translate(1050, 720)">
    <rect x="0" y="0" width="180" height="50" rx="6" fill="#b71c1c"/>
    <text x="90" y="20" text-anchor="middle" class="badge-text" style="font-size:14px">TOTAL: 7 ms</text>
    <text x="90" y="38" text-anchor="middle" class="badge-text" style="font-size:9px">eval + decision + output</text>
</g>

</svg>
