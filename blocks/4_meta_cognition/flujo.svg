<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="900" height="900" viewBox="0 0 900 900">
<defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.12"/>
    </filter>
    
    <style>
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #263238; }
        .title { font-size: 22px; font-weight: 800; fill: #fff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-size: 13px; font-weight: 700; fill: #000; }
        .detail { font-size: 11px; fill: #455a64; }
        .code { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #4a148c; }
        
        .box-step { fill: #ffffff; stroke: #455a64; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-federated { fill: #e0f2f1; stroke: #00695c; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-governance { fill: #fff3e0; stroke: #ef6c00; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-privacy { fill: #e8eaf6; stroke: #3f51b5; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        .arrow { stroke: #546e7a; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-purple { stroke: #4a148c; stroke-width: 2; fill: none; marker-end: url(#arrowhead-purple); }
        
        .badge { fill: #263238; rx: 4; }
        .badge-async { fill: #4a148c; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
    
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#546e7a"/>
    </marker>
    <marker id="arrowhead-purple" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#4a148c"/>
    </marker>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="900" height="70" fill="#4a148c"/>
<text x="450" y="35" text-anchor="middle" class="title">LAYER 4: META-COGNITION FLOW</text>
<text x="450" y="55" text-anchor="middle" class="subtitle">Async Processing • No Real-Time Impact</text>

<!-- STEP 1: INPUT -->
<g transform="translate(300, 100)">
    <rect x="0" y="0" width="300" height="70" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">1. RECEIVE ENGINE DATA</text>
    <text x="150" y="48" text-anchor="middle" class="code">ttc, risks, tracks, validation</text>
    <text x="150" y="62" text-anchor="middle" class="detail">Async copy from real-time path</text>
</g>

<!-- Split arrows -->
<path d="M 450 170 L 450 200 L 150 200 L 150 250" class="arrow"/>
<path d="M 450 170 L 450 250" class="arrow"/>
<path d="M 450 170 L 450 200 L 750 200 L 750 250" class="arrow"/>

<!-- PARALLEL PROCESSING (3 columns) -->

<!-- Column 1: Fleet Sync -->
<g transform="translate(50, 250)">
    <rect x="0" y="0" width="200" height="180" class="box-federated"/>
    <text x="100" y="25" text-anchor="middle" class="label" fill="#00695c">FLEET SYNC</text>
    
    <text x="100" y="50" text-anchor="middle" class="code" style="fill:#00695c">broadcast_alert()</text>
    <text x="100" y="70" text-anchor="middle" class="detail">UDP to all nodes</text>
    
    <text x="100" y="100" text-anchor="middle" class="code" style="fill:#00695c">receive_status()</text>
    <text x="100" y="120" text-anchor="middle" class="detail">Merge fleet map</text>
    
    <text x="100" y="150" text-anchor="middle" class="code" style="fill:#00695c">federated_update()</text>
    <text x="100" y="168" text-anchor="middle" class="detail">Model gradients</text>
</g>

<!-- Column 2: Governance -->
<g transform="translate(350, 250)">
    <rect x="0" y="0" width="200" height="180" class="box-governance"/>
    <text x="100" y="25" text-anchor="middle" class="label" fill="#ef6c00">GOVERNANCE</text>
    
    <text x="100" y="50" text-anchor="middle" class="code" style="fill:#ef6c00">log_decision()</text>
    <text x="100" y="70" text-anchor="middle" class="detail">TraceEntry + rationale</text>
    
    <text x="100" y="100" text-anchor="middle" class="code" style="fill:#ef6c00">sign_entry()</text>
    <text x="100" y="120" text-anchor="middle" class="detail">Cryptographic signature</text>
    
    <text x="100" y="150" text-anchor="middle" class="code" style="fill:#ef6c00">check_fail_mode()</text>
    <text x="100" y="168" text-anchor="middle" class="detail">Fail-safe / Fail-op</text>
</g>

<!-- Column 3: Privacy -->
<g transform="translate(650, 250)">
    <rect x="0" y="0" width="200" height="180" class="box-privacy"/>
    <text x="100" y="25" text-anchor="middle" class="label" fill="#3f51b5">PRIVACY</text>
    
    <text x="100" y="50" text-anchor="middle" class="code" style="fill:#3f51b5">validate_anon()</text>
    <text x="100" y="70" text-anchor="middle" class="detail">Check no PII in output</text>
    
    <text x="100" y="100" text-anchor="middle" class="code" style="fill:#3f51b5">encrypt_stream()</text>
    <text x="100" y="120" text-anchor="middle" class="detail">TLS 1.3 + AES-256</text>
    
    <text x="100" y="150" text-anchor="middle" class="code" style="fill:#3f51b5">byzantine_check()</text>
    <text x="100" y="168" text-anchor="middle" class="detail">Krum aggregation</text>
</g>

<!-- Merge arrows -->
<path d="M 150 430 L 150 480 L 450 480" class="arrow"/>
<path d="M 450 430 L 450 480" class="arrow" fill="none"/>
<path d="M 750 430 L 750 480 L 450 480" class="arrow"/>

<!-- STEP 2: OUTPUT ROUTING -->
<g transform="translate(250, 520)">
    <rect x="0" y="0" width="400" height="200" class="box-step"/>
    <text x="200" y="25" text-anchor="middle" class="label">2. OUTPUT ROUTING</text>
    
    <rect x="20" y="45" width="170" height="35" rx="4" fill="#e0f2f1" stroke="#00695c"/>
    <text x="105" y="68" text-anchor="middle" class="code" style="fill:#00695c">→ Fleet Nodes (UDP)</text>
    
    <rect x="210" y="45" width="170" height="35" rx="4" fill="#fff3e0" stroke="#ef6c00"/>
    <text x="295" y="68" text-anchor="middle" class="code" style="fill:#ef6c00">→ Audit Storage</text>
    
    <rect x="20" y="95" width="170" height="35" rx="4" fill="#e8eaf6" stroke="#3f51b5"/>
    <text x="105" y="118" text-anchor="middle" class="code" style="fill:#3f51b5">→ GDPR Stream</text>
    
    <rect x="210" y="95" width="170" height="35" rx="4" fill="#f3e5f5" stroke="#4a148c"/>
    <text x="295" y="118" text-anchor="middle" class="code">→ Model Aggregator</text>
    
    <rect x="115" y="150" width="170" height="35" rx="4" fill="#ffebee" stroke="#d32f2f"/>
    <text x="200" y="173" text-anchor="middle" class="code" style="fill:#d32f2f">→ Safety Layer 5</text>
</g>

<!-- NOTE: Async -->
<rect x="600" y="760" width="230" height="50" rx="6" fill="#4a148c"/>
<text x="715" y="783" text-anchor="middle" class="badge-text" style="font-size:12px">ALL ASYNC</text>
<text x="715" y="800" text-anchor="middle" class="badge-text" style="font-size:9px">No impact on &lt;100ms budget</text>

</svg>
