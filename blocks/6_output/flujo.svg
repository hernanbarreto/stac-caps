<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="800" height="1200" viewBox="0 0 800 1200">
<defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.12"/>
    </filter>
    
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#546e7a"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#d32f2f"/>
    </marker>

    <style>
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #263238; }
        .title { font-size: 22px; font-weight: 800; fill: #fff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-size: 13px; font-weight: 700; fill: #000; }
        .detail { font-size: 11px; fill: #455a64; }
        .code { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #455a64; }
        
        .box-step { fill: #ffffff; stroke: #455a64; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-critical { fill: #ffebee; stroke: #d32f2f; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-output { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-decision { fill: #fff9c4; stroke: #f57f17; stroke-width: 2; filter: url(#shadow); rx: 4; }
        
        .arrow { stroke: #546e7a; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-critical { stroke: #d32f2f; stroke-width: 3; fill: none; marker-end: url(#arrowhead-red); }
        
        .badge { fill: #263238; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="800" height="70" fill="#455a64"/>
<text x="400" y="35" text-anchor="middle" class="title">OUTPUT FLOW</text>
<text x="400" y="55" text-anchor="middle" class="subtitle">Safety Decision → Multi-Channel Routing → Audit</text>

<!-- STEP 1: RECEIVE DECISION -->
<g transform="translate(250, 100)">
    <rect x="0" y="0" width="300" height="70" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">1. RECEIVE DECISION</text>
    <text x="150" y="48" text-anchor="middle" class="code">SafetyDecision from Layer 5</text>
</g>
<line x1="400" y1="170" x2="400" y2="200" class="arrow"/>

<!-- STEP 2: IS EMERGENCY? -->
<g transform="translate(250, 200)">
    <polygon points="150,0 300,50 150,100 0,50" fill="#ffebee" stroke="#d32f2f" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="45" text-anchor="middle" class="label" fill="#d32f2f">2. EMERGENCY?</text>
    <text x="150" y="60" text-anchor="middle" class="detail" fill="#d32f2f">action == EMERGENCY_BRAKE</text>
</g>

<!-- YES: HARDWIRE GPIO -->
<line x1="550" y1="250" x2="650" y2="250" class="arrow-critical"/>
<text x="600" y="240" class="detail" fill="#d32f2f">Yes</text>

<g transform="translate(650, 210)">
    <rect x="0" y="0" width="130" height="80" class="box-critical"/>
    <text x="65" y="25" text-anchor="middle" class="label" fill="#d32f2f">GPIO BRAKE</text>
    <text x="65" y="48" text-anchor="middle" class="code" style="fill:#d32f2f">Hardware relay</text>
    <rect x="25" y="55" width="80" height="15" class="badge" style="fill:#d32f2f"/>
    <text x="65" y="66" text-anchor="middle" class="badge-text">&lt;0.5 ms</text>
</g>

<!-- NO: Continue -->
<line x1="400" y1="300" x2="400" y2="330" class="arrow"/>
<text x="415" y="320" class="detail" fill="#2e7d32">No</text>

<!-- STEP 3: TRACEABILITY HASH (Added for Consistency) -->
<g transform="translate(250, 330)">
    <rect x="0" y="0" width="300" height="70" class="box-step" style="stroke:#33691e"/>
    <text x="150" y="25" text-anchor="middle" class="label" style="fill:#33691e">3. TRACEABILITY HASH</text>
    <text x="150" y="48" text-anchor="middle" class="code">SHA256(Decision + Avatar)</text>
</g>
<line x1="400" y1="400" x2="400" y2="430" class="arrow"/>

<!-- STEP 4: SERIALIZE -->
<g transform="translate(250, 430)">
    <rect x="0" y="0" width="300" height="70" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">4. SERIALIZE MESSAGE</text>
    <text x="150" y="48" text-anchor="middle" class="code">Priority encoding + timestamp</text>
</g>
<line x1="400" y1="500" x2="400" y2="530" class="arrow"/>

<!-- STEP 5: ROUTE BY PRIORITY -->
<g transform="translate(250, 530)">
    <polygon points="150,0 300,50 150,100 0,50" fill="#fff9c4" stroke="#f57f17" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="45" text-anchor="middle" class="label" fill="#f57f17">5. ROUTE</text>
    <text x="150" y="60" text-anchor="middle" class="detail" fill="#f57f17">by priority level</text>
</g>

<!-- PRIORITY BRANCHES -->
<line x1="250" y1="580" x2="100" y2="630" class="arrow-critical"/>
<text x="150" y="600" class="detail" fill="#d32f2f">P1</text>

<line x1="400" y1="630" x2="400" y2="680" class="arrow"/>
<text x="415" y="660" class="detail">P2-3</text>

<line x1="550" y1="580" x2="700" y2="630" class="arrow"/>
<text x="650" y="610" class="detail">P4-5</text>

<!-- CAN BUS -->
<g transform="translate(30, 630)">
    <rect x="0" y="0" width="140" height="70" class="box-critical"/>
    <text x="70" y="25" text-anchor="middle" class="label" fill="#d32f2f">CAN BUS</text>
    <text x="70" y="48" text-anchor="middle" class="code" style="fill:#d32f2f">SERVICE_BRAKE</text>
    <rect x="30" y="52" width="80" height="12" class="badge" style="fill:#d32f2f"/>
    <text x="70" y="62" text-anchor="middle" class="badge-text">&lt;1 ms</text>
</g>

<!-- MQTT/SCADA -->
<g transform="translate(320, 680)">
    <rect x="0" y="0" width="160" height="70" class="box-step"/>
    <text x="80" y="25" text-anchor="middle" class="label">MQTT + SCADA</text>
    <text x="80" y="48" text-anchor="middle" class="code">WARNING / CAUTION</text>
    <rect x="40" y="52" width="80" height="12" class="badge"/>
    <text x="80" y="62" text-anchor="middle" class="badge-text">&lt;50 ms</text>
</g>

<!-- TELEMETRY -->
<g transform="translate(630, 630)">
    <rect x="0" y="0" width="140" height="70" class="box-step"/>
    <text x="70" y="25" text-anchor="middle" class="label">TELEMETRY</text>
    <text x="70" y="48" text-anchor="middle" class="code">Status + metrics</text>
    <rect x="30" y="52" width="80" height="12" class="badge"/>
    <text x="70" y="62" text-anchor="middle" class="badge-text">&lt;100 ms</text>
</g>

<!-- CONVERGE: Collect all outputs to Success Check -->
    <path d="M 100 700 L 100 780 L 400 780 L 400 800" class="arrow"/>
    <line x1="400" y1="750" x2="400" y2="800" class="arrow"/>
    <path d="M 700 700 L 700 780 L 400 780 L 400 800" class="arrow"/>

    <!-- STEP 6: SUCCESS CHECK -->
    <g transform="translate(250, 800)">
        <polygon points="150,0 300,50 150,100 0,50" fill="#fff9c4" stroke="#f57f17" stroke-width="2" filter="url(#shadow)"/>
        <text x="150" y="45" text-anchor="middle" class="label" fill="#f57f17">6. SUCCESS?</text>
        <text x="150" y="60" text-anchor="middle" class="detail" fill="#f57f17">channel ACK</text>
    </g>

    <!-- FALLBACK LOOP (Updated Y-Axis) -->
    <line x1="550" y1="850" x2="650" y2="850" class="arrow" style="stroke:#ef6c00"/>
    <text x="600" y="840" class="detail" fill="#ef6c00">No</text>

    <g transform="translate(650, 815)">
        <rect x="0" y="0" width="120" height="70" rx="6" fill="#fff3e0" stroke="#ef6c00" stroke-width="2"/>
        <text x="60" y="25" text-anchor="middle" class="label" fill="#ef6c00">FALLBACK</text>
        <text x="60" y="48" text-anchor="middle" class="code" style="fill:#ef6c00">Try backup</text>
        <text x="60" y="62" text-anchor="middle" class="code" style="fill:#ef6c00">channel</text>
    </g>
    
    <!-- Long loop back to Route (Step 5 at y=530) -->
    <path d="M 770 850 L 800 850 L 800 515 L 400 515 L 400 530" class="arrow" style="stroke-dasharray:4 2"/>

<!-- YES: AUDIT -->
<line x1="400" y1="900" x2="400" y2="930" class="arrow"/>
<text x="415" y="920" class="detail" fill="#2e7d32">Yes</text>

<!-- STEP 7: AUDIT LOG -->
<g transform="translate(250, 930)">
    <rect x="0" y="0" width="300" height="70" class="box-output"/>
    <text x="150" y="25" text-anchor="middle" class="label" fill="#2e7d32">7. AUDIT LOG</text>
    <text x="150" y="48" text-anchor="middle" class="code" style="fill:#2e7d32">Signed entry + cloud backup (async)</text>
</g>

</svg>
