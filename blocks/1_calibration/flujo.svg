<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="900" height="1000" viewBox="0 0 900 1000">
<defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="3" dy="3" stdDeviation="4" flood-opacity="0.12"/>
    </filter>
    
    <style>
        text { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; fill: #263238; }
        .title { font-size: 22px; font-weight: 800; fill: #fff; }
        .subtitle { font-size: 14px; fill: #eceff1; }
        .label { font-size: 13px; font-weight: 700; fill: #000; }
        .detail { font-size: 11px; fill: #455a64; }
        .code { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #e65100; }
        
        .box-step { fill: #ffffff; stroke: #455a64; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-calib { fill: #fffde7; stroke: #fbc02d; stroke-width: 2; filter: url(#shadow); rx: 8; }
        .box-decision { fill: #ffebee; stroke: #c62828; stroke-width: 2; filter: url(#shadow); }
        .box-output { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; filter: url(#shadow); rx: 8; }
        
        .arrow { stroke: #546e7a; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-red { stroke: #d32f2f; stroke-width: 2; fill: none; marker-end: url(#arrowhead-red); }
        
        .badge { fill: #263238; rx: 4; }
        .badge-text { font-size: 9px; font-weight: 700; fill: #fff; font-family: 'Consolas', monospace; }
    </style>
    
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#546e7a"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
        <polygon points="0 0, 8 3, 0 6" fill="#d32f2f"/>
    </marker>
</defs>

<!-- HEADER -->
<rect x="0" y="0" width="900" height="70" fill="#f57f17"/>
<text x="450" y="35" text-anchor="middle" class="title">CALIBRATION FLOW</text>
<text x="450" y="55" text-anchor="middle" class="subtitle">Startup → Runtime → Fallback</text>

<!-- STEP 1: STARTUP CHECK -->
<g transform="translate(300, 100)">
    <rect x="0" y="0" width="300" height="70" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">1. SYSTEM STARTUP</text>
    <text x="150" y="48" text-anchor="middle" class="code">Load intrinsics (camera matrix K)</text>
</g>
<line x1="450" y1="170" x2="450" y2="200" class="arrow"/>

<!-- STEP 2: CALIBRATION AVAILABLE? -->
<g transform="translate(300, 200)">
    <polygon points="150,0 300,45 150,90 0,45" fill="#fff9c4" stroke="#f57f17" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="40" text-anchor="middle" class="label" fill="#f57f17">2. SAVED CALIB?</text>
    <text x="150" y="55" text-anchor="middle" class="detail" fill="#e65100">from previous session</text>
</g>

<!-- NO: HARD INIT -->
<line x1="600" y1="245" x2="700" y2="245" class="arrow"/>
<text x="650" y="235" class="detail" fill="#7b1fa2">No</text>

<g transform="translate(700, 200)">
    <rect x="0" y="0" width="160" height="90" class="box-calib" style="stroke:#7b1fa2"/>
    <text x="80" y="25" text-anchor="middle" class="label" fill="#7b1fa2">HARD INIT</text>
    <text x="80" y="45" text-anchor="middle" class="code" style="fill:#7b1fa2">Operator clicks</text>
    <text x="80" y="60" text-anchor="middle" class="code" style="fill:#7b1fa2">rail heads (2x)</text>
    <text x="80" y="78" text-anchor="middle" class="detail" fill="#7b1fa2">1435mm reference</text>
</g>
<path d="M 780 290 L 780 350 L 450 350" class="arrow"/>

<!-- YES: LOAD -->
<line x1="450" y1="290" x2="450" y2="350" class="arrow"/>
<text x="465" y="320" class="detail" fill="#2e7d32">Yes</text>

<!-- STEP 3: FRAME LOOP -->
<g transform="translate(300, 350)">
    <rect x="0" y="0" width="300" height="70" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">3. RECEIVE FRAME</text>
    <text x="150" y="48" text-anchor="middle" class="code">From Layer 0 (Sensor)</text>
</g>
<line x1="450" y1="420" x2="450" y2="450" class="arrow"/>

<!-- STEP 4: RAILS VISIBLE? -->
<g transform="translate(300, 450)">
    <polygon points="150,0 300,45 150,90 0,45" fill="#ffebee" stroke="#d32f2f" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="40" text-anchor="middle" class="label" fill="#d32f2f">4. RAILS VISIBLE?</text>
    <text x="150" y="55" text-anchor="middle" class="detail" fill="#d32f2f">edge detection</text>
</g>

<!-- NO: FALLBACK -->
<line x1="600" y1="495" x2="700" y2="495" class="arrow-red"/>
<text x="650" y="485" class="detail" fill="#d32f2f">No</text>

<g transform="translate(700, 455)">
    <rect x="0" y="0" width="160" height="80" class="box-decision"/>
    <text x="80" y="25" text-anchor="middle" class="label" fill="#d32f2f">LANDMARK</text>
    <text x="80" y="40" text-anchor="middle" class="label" fill="#d32f2f">FALLBACK</text>
    <text x="80" y="58" text-anchor="middle" class="code" style="fill:#d32f2f">Use stored keypoints</text>
    <text x="80" y="72" text-anchor="middle" class="detail" fill="#d32f2f">PnP solve</text>
</g>
<path d="M 780 535 L 780 580 L 600 580" class="arrow"/>

<!-- YES: RAIL CALIBRATION -->
<line x1="450" y1="540" x2="450" y2="580" class="arrow"/>
<text x="465" y="560" class="detail" fill="#2e7d32">Yes</text>

<!-- STEP 5: RAIL CALIBRATION -->
<g transform="translate(300, 580)">
    <rect x="0" y="0" width="300" height="80" class="box-calib"/>
    <text x="150" y="25" text-anchor="middle" class="label" fill="#f57f17">5. RAIL CALIBRATION</text>
    <text x="150" y="48" text-anchor="middle" class="code">Detect rail heads + vanishing point</text>
    <text x="150" y="65" text-anchor="middle" class="code">Update extrinsics + scale</text>
</g>
<line x1="450" y1="660" x2="450" y2="690" class="arrow"/>

<!-- STEP 6: UPDATE LANDMARKS -->
<g transform="translate(300, 690)">
    <rect x="0" y="0" width="300" height="70" class="box-step"/>
    <text x="150" y="25" text-anchor="middle" class="label">6. UPDATE LANDMARKS</text>
    <text x="150" y="48" text-anchor="middle" class="code">Add new keypoints to database</text>
</g>
<line x1="450" y1="760" x2="450" y2="790" class="arrow"/>

<!-- STEP 7: OUTPUT -->
<g transform="translate(250, 790)">
    <rect x="0" y="0" width="400" height="100" class="box-output"/>
    <text x="200" y="25" text-anchor="middle" class="label" fill="#2e7d32">7. OUTPUT CALIBRATION</text>
    <text x="200" y="48" text-anchor="middle" class="code" style="fill:#2e7d32">intrinsics, extrinsics, scale_factor</text>
    <text x="200" y="65" text-anchor="middle" class="detail" fill="#2e7d32">→ Engine 1A, Engine 1B, 3D Fusion</text>
    <rect x="160" y="75" width="80" height="16" class="badge" style="fill:#2e7d32"/>
    <text x="200" y="87" text-anchor="middle" class="badge-text">PARALLEL</text>
</g>

<!-- LOOP BACK -->
<path d="M 250 840 L 100 840 L 100 385 L 300 385" class="arrow" style="stroke-dasharray: 5,3"/>
<text x="100" y="620" transform="rotate(-90, 100, 620)" class="detail">Next Frame</text>

</svg>
